name: "Deploy Sytesbook WPWedding"

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Select the environment
        required: true
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.environment }}
    steps:
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: "8.3"

    - name: Check PHP version
      run: php --version

    - name: "Checkout: sytesbook-wpwedding-deploy"
      uses: actions/checkout@v4
      with:
        repository: dkuratowski/sytesbook-wpwedding-deploy
        path: repos/sytesbook-wpwedding-deploy
        token: ${{ secrets.GIT_ACCESS_TOKEN }}

    - name: "Checkout: sytesbook-wpwedding"
      uses: actions/checkout@v4
      with:
        repository: dkuratowski/sytesbook-wpwedding
        path: repos/sytesbook-wpwedding
        token: ${{ secrets.GIT_ACCESS_TOKEN }}

    - name: "Checkout: sytesbook-wpwedding-installer"
      uses: actions/checkout@v4
      with:
        repository: dkuratowski/sytesbook-wpwedding-installer
        path: repos/sytesbook-wpwedding-installer
        token: ${{ secrets.GIT_ACCESS_TOKEN }}

    - name: "Checkout: sytes-react"
      uses: actions/checkout@v4
      with:
        repository: dkuratowski/sytes-react
        path: repos/sytes-react
        token: ${{ secrets.GIT_ACCESS_TOKEN }}

    - name: "Composer install: sytesbook-wpwedding"
      working-directory: ./repos/sytesbook-wpwedding
      run: composer install

    - name: "NPM install: sytes-react"
      working-directory: ./repos/sytes-react
      run: npm install

    - name: "NPM install and build: sytesbook-wpwedding/src/wp-content/themes/sytesbook-wpwedding"
      working-directory: ./repos/sytesbook-wpwedding/src/wp-content/themes/sytesbook-wpwedding
      run: |
        npm install
        npm run build

    - name: Preparing deployment
      id: prepare_deployment
      run: |
        deployment_id=$(LC_CTYPE=C tr -dc A-Za-z0-9 < /dev/urandom | head -c 32 | xargs)
        mkdir -p ./installer/$deployment_id
        touch ./installer/index.php
        echo "<?php /* Silence is golden */ ?>" > ./installer/index.php
        cp ./repos/sytesbook-wpwedding-deploy/installer/* ./installer/$deployment_id
        echo "deployment_id=$deployment_id" >> $GITHUB_OUTPUT
        echo "Deployment ID: $deployment_id"

    - name: Creating ZIP to be deployed
      run: |
        rm -r ./repos/sytesbook-wpwedding/wp/wp-content
        rm -r ./repos/sytesbook-wpwedding/src/wp-content/themes/sytesbook-wpwedding/node_modules
        rm ./repos/sytesbook-wpwedding/wp/wp-config.php
        mkdir ./deployment
        cd ./repos/sytesbook-wpwedding
        zip -r "../../deployment/deployment_${{ steps.prepare_deployment.outputs.deployment_id }}.zip" src vendor wp

    - name: Deploy ZIP to the webserver
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ vars.FTP_SERVER }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deployment/
        server-dir: "${{ vars.DEPLOYMENT_FOLDER_ON_SERVER }}/"

    - name: Deploy installer scripts to the webserver
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ vars.FTP_SERVER }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./installer/
        server-dir: "${{ vars.DOMAIN_FOLDER_ON_SERVER }}/installer/"

    - name: Execute installer scripts
      working-directory: ./repos/sytesbook-wpwedding-deploy
      run: |
        ./install.sh ${{ vars.DOMAIN_NAME }} ${{ steps.prepare_deployment.outputs.deployment_id }} ${{ vars.DEPLOYMENT_FOLDER_ON_SERVER }} ${{ vars.DOMAIN_FOLDER_ON_SERVER }}
